(function(){"use strict";function calculateElementValue(e,s){if(e==="期数")return s.period%100;if(e==="期数尾")return s.period%10;if(e==="期数合")return String(s.period).split("").reduce((i,r)=>i+parseInt(r),0);const o=s.numbers[6];return e==="特号"?o:e==="特尾"?o%10:e==="特头"?Math.floor(o/10):e==="特合"?String(o).split("").reduce((i,r)=>i+parseInt(r),0):0}function evaluateExpression(expression,data){let normalized=expression;const elements=["期数","期数尾","期数合","特号","特尾","特头","特合"];for(const e of elements){const s=calculateElementValue(e,data);normalized=normalized.replace(new RegExp(e,"g"),s.toString())}normalized=normalized.replace(/[×\*÷\/%\-]/g,"");try{return/^[\d+()\s]+$/.test(normalized)?Math.floor(eval(normalized)):0}catch(e){return 0}}function applyCycle(e,s){switch(s){case"尾数类":return(e%10+10)%10;case"头数类":return Math.min(Math.max(e,0),4);case"合数类":return Math.min(Math.max(e,0),13);case"肖位类":return(e%12+12)%12||12;default:return e}}function getExpandedResults(e,s,o,l){const i=[];if(l==="单特类")for(let r=-s;r<=o;r++){const p=e+r;p>=1&&p<=49&&i.push(p)}else for(let r=-s;r<=o;r++)i.push(applyCycle(e+r,l));return[...new Set(i)]}self.onmessage=e=>{const{type:s,formulas:o,historyData:l,targetPeriod:i}=e.data;if(s==="verify")try{const r=[];for(let u=0;u<o.length;u++){const t=o[u];u%50===0&&self.postMessage({type:"progress",current:u,total:o.length});let a;if(i){const n=l.findIndex(c=>c.period===i);n!==-1?a=l.slice(n,n+t.periods):a=l.slice(0,t.periods)}else a=l.slice(0,t.periods);const d=[],f=[];for(let n=0;n<a.length;n++){const c=a[n],y=n>0?a[n-1]:c,E=evaluateExpression(t.expression,y)+t.offset,h=applyCycle(E,t.resultType),m=getExpandedResults(h,t.leftExpand,t.rightExpand,t.resultType),x=m.includes(c.numbers[6]);d.push(x),f.push({period:c.period,result:h,expandedResults:m,targetValue:c.numbers[6],hit:x})}const g=d.filter(n=>n).length;r.push({formula:{id:`f_${Date.now()}_${u}`,expression:t.rawExpression,rule:t.rule,resultType:t.resultType,offset:t.offset,periods:t.periods,leftExpand:t.leftExpand,rightExpand:t.rightExpand},hits:d,hitCount:g,totalPeriods:a.length,hitRate:a.length>0?g/a.length:0,results:f.length>0?f[0].expandedResults.map(n=>String(n)):[],periodResults:f,originalLineIndex:t.originalLineIndex||0,targetPeriod:i})}self.postMessage({type:"complete",results:r})}catch(r){self.postMessage({type:"error",error:String(r)})}}})();
