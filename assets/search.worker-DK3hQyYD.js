(function(){"use strict";const WAVE_COLORS={红:[1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46],蓝:[3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48],绿:[5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49]},FIVE_ELEMENTS={金:[4,5,12,13,26,27,34,35,42,43],木:[8,9,16,17,24,25,38,39,46,47],水:[1,14,15,22,23,30,31,44,45],火:[2,3,10,11,18,19,32,33,40,41,48,49],土:[6,7,20,21,28,29,36,37]},BIG_SMALL_ODD_EVEN={小单:[1,3,5,7,9,11,13,15,17,19,21,23],小双:[2,4,6,8,10,12,14,16,18,20,22,24],大单:[25,27,29,31,33,35,37,39,41,43,45,47,49],大双:[26,28,30,32,34,36,38,40,42,44,46,48]},BASE_ZODIAC_NUMBERS={1:[1,13,25,37,49],2:[2,14,26,38],3:[3,15,27,39],4:[4,16,28,40],5:[5,17,29,41],6:[6,18,30,42],7:[7,19,31,43],8:[8,20,32,44],9:[9,21,33,45],10:[10,22,34,46],11:[11,23,35,47],12:[12,24,36,48]},ZODIAC_NAMES={1:"鼠",2:"牛",3:"虎",4:"兔",5:"龙",6:"蛇",7:"马",8:"羊",9:"猴",10:"鸡",11:"狗",12:"猪"};function getZodiacMap(e){const t={};for(let s=1;s<=12;s++){const n=((e-s)%12+12)%12+1,r=ZODIAC_NAMES[n];t[r]=BASE_ZODIAC_NUMBERS[s]}return t}function getAllElements(){const e=[];e.push("期数","期数尾","期数合");for(let t=1;t<=6;t++)e.push(`平${t}号`,`平${t}尾`,`平${t}头`,`平${t}合`);return e.push("特号","特尾","特头","特合"),e}function parseFormula(e){try{const t=e.match(/^\[([DL])([^=]+)\]([^=]+)=(-?\d+)(?:左(\d+))?(?:右(\d+))?$/);if(!t)return null;const s=t[1],n=t[2],r=t[3],a=parseInt(t[4])||15,o=t[5]?parseInt(t[5]):0,u=t[6]?parseInt(t[6]):0;let i=0;const l=r.match(/[+-]?\d+$/);return l&&(i=parseInt(l[0])),{expression:r.replace(/[+-]?\d+$/,""),rule:s,resultType:n,periods:a,offset:i,leftExpand:o,rightExpand:u,rawExpression:r}}catch{return null}}function evaluateExpression(expression,data){let normalized=expression;normalized=normalized.replace(/期数/g,String(data.period%100)),normalized=normalized.replace(/期数尾/g,String(data.period%10));const periodSum=String(data.period).split("").reduce((e,t)=>e+parseInt(t),0);normalized=normalized.replace(/期数合/g,String(periodSum));for(let e=1;e<=6;e++){const t=data.numbers[e-1];normalized=normalized.replace(new RegExp(`平${e}号`,"g"),String(t)),normalized=normalized.replace(new RegExp(`平${e}尾`,"g"),String(t%10)),normalized=normalized.replace(new RegExp(`平${e}头`,"g"),String(Math.floor(t/10)));const s=String(t).split("").reduce((n,r)=>n+parseInt(r),0);normalized=normalized.replace(new RegExp(`平${e}合`,"g"),String(s))}const teNum=data.numbers[6];normalized=normalized.replace(/特号/g,String(teNum)),normalized=normalized.replace(/特尾/g,String(teNum%10)),normalized=normalized.replace(/特头/g,String(Math.floor(teNum/10)));const teSum=String(teNum).split("").reduce((e,t)=>e+parseInt(t),0);normalized=normalized.replace(/特合/g,String(teSum)),normalized=normalized.replace(/[×\*÷\/%\-]/g,"");try{return/^[\d+()\s]+$/.test(normalized)?Math.floor(eval(normalized)):0}catch{return 0}}function applyCycle(e,t){switch(t){case"尾数类":return(e%10+10)%10;case"头数类":return Math.min(Math.max(e,0),4);case"合数类":return Math.min(Math.max(e,0),13);case"波色类":return(e%3+3)%3;case"五行类":return(e%5+5)%5;case"肖位类":return(e%12+12)%12||12;default:return e}}function getExpandedResults(e,t,s,n){const r=[];if(n==="单特类")for(let a=-t;a<=s;a++){const o=e+a;o>=1&&o<=49&&r.push(o)}else for(let a=-t;a<=s;a++)r.push(applyCycle(e+a,n));return[...new Set(r)]}function getNumberAttribute(e,t,s){switch(t){case"尾数类":return e%10;case"头数类":return Math.floor(e/10);case"合数类":return String(e).split("").reduce((n,r)=>n+parseInt(r),0);case"波色类":return WAVE_COLORS.红.includes(e)?0:WAVE_COLORS.蓝.includes(e)?1:WAVE_COLORS.绿.includes(e)?2:0;case"五行类":return FIVE_ELEMENTS.金.includes(e)?0:FIVE_ELEMENTS.木.includes(e)?1:FIVE_ELEMENTS.水.includes(e)?2:FIVE_ELEMENTS.火.includes(e)?3:FIVE_ELEMENTS.土.includes(e)?4:0;case"肖位类":{const n=getZodiacMap(s);for(let r=1;r<=12;r++){const a=ZODIAC_NAMES[r];if(n[a]?.includes(e))return r}return 1}case"大小单双类":return BIG_SMALL_ODD_EVEN.小单.includes(e)?0:BIG_SMALL_ODD_EVEN.小双.includes(e)?1:BIG_SMALL_ODD_EVEN.大单.includes(e)?2:BIG_SMALL_ODD_EVEN.大双.includes(e)?3:0;default:return e}}function verifyFormula(e,t,s,n,r,a){if(!e)return{hitRate:0,hitCount:0,totalPeriods:0};const o=t.slice(0,n);let u=0;for(let i=0;i<o.length;i++){const l=o[i],m=i>0?o[i-1]:l,d=evaluateExpression(e.expression,m)+e.offset+s,E=applyCycle(d,e.resultType),c=getExpandedResults(E,e.leftExpand+r,e.rightExpand+a,e.resultType),p=getNumberAttribute(l.numbers[6],e.resultType,l.zodiacYear);c.includes(p)&&u++}return{hitRate:o.length>0?u/o.length:0,hitCount:u,totalPeriods:o.length}}function generateRandomFormula(e,t,s,n,r,a,o,u){const l=[...e].sort(()=>Math.random()-.5).slice(0,Math.min(t,e.length));let m=l[0];for(let c=1;c<l.length;c++)m+="+"+l[c];const g=a>=0?`+${a}`:`${a}`,d=o>0?`左${o}`:"",E=u>0?`右${u}`:"";return`[${n}${s}]${m}${g}=${r}${d}${E}`}self.onmessage=e=>{const{type:t,historyData:s,targetHitRate:n,maxCount:r,strategy:a,resultTypes:o,offset:u,periods:i,leftExpand:l,rightExpand:m}=e.data;if(t==="search")try{const g=getAllElements(),d=[],E=new Set;let c,p,h;switch(a){case"fast":c=1,p=10,h=Math.min(r*10,5e3);break;case"standard":c=1,p=15,h=Math.min(r*20,1e4);break;case"deep":c=1,p=20,h=Math.min(r*30,2e4);break;default:c=1,p=10,h=5e3}const R=["D","L"];for(let f=0;f<h&&d.length<r;f++){const S=o[Math.floor(Math.random()*o.length)],I=R[Math.floor(Math.random()*R.length)],N=Math.floor(Math.random()*(p-c+1))+c,M=generateRandomFormula(g,N,S,I,i,u,l,m);if(E.has(M))continue;E.add(M);const y=parseFormula(M);if(!y)continue;const z=verifyFormula(y,s,0,i,0,0),_=z.hitRate*100;(Math.abs(_-n)<=5||n===0&&_===0||n===100&&_===100)&&d.push({formula:M,hitRate:z.hitRate,hitCount:z.hitCount,totalPeriods:z.totalPeriods}),f%100===0&&self.postMessage({type:"progress",current:f,total:h,found:d.length})}n>=50?d.sort((f,S)=>S.hitRate-f.hitRate):d.sort((f,S)=>f.hitRate-S.hitRate),self.postMessage({type:"complete",results:d.slice(0,r)})}catch(g){self.postMessage({type:"error",error:String(g)})}}})();
