(function(){"use strict";const WAVE_COLORS={红:[1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46],蓝:[3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48],绿:[5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49]},FIVE_ELEMENTS={金:[4,5,12,13,26,27,34,35,42,43],木:[8,9,16,17,24,25,38,39,46,47],水:[1,14,15,22,23,30,31,44,45],火:[2,3,10,11,18,19,32,33,40,41,48,49],土:[6,7,20,21,28,29,36,37]},BIG_SMALL_ODD_EVEN={小单:[1,3,5,7,9,11,13,15,17,19,21,23],小双:[2,4,6,8,10,12,14,16,18,20,22,24],大单:[25,27,29,31,33,35,37,39,41,43,45,47,49],大双:[26,28,30,32,34,36,38,40,42,44,46,48]},BASE_ZODIAC_NUMBERS={1:[1,13,25,37,49],2:[2,14,26,38],3:[3,15,27,39],4:[4,16,28,40],5:[5,17,29,41],6:[6,18,30,42],7:[7,19,31,43],8:[8,20,32,44],9:[9,21,33,45],10:[10,22,34,46],11:[11,23,35,47],12:[12,24,36,48]},ZODIAC_NAMES={1:"鼠",2:"牛",3:"虎",4:"兔",5:"龙",6:"蛇",7:"马",8:"羊",9:"猴",10:"鸡",11:"狗",12:"猪"};function getZodiacMap(e){const r={};for(let s=1;s<=12;s++){const o=((e-s)%12+12)%12+1,t=ZODIAC_NAMES[o];r[t]=BASE_ZODIAC_NUMBERS[s]}return r}function getNumberAttribute(e,r,s){switch(r){case"尾数类":return e%10;case"头数类":return Math.floor(e/10);case"合数类":return String(e).split("").reduce((o,t)=>o+parseInt(t),0);case"波色类":return WAVE_COLORS.红.includes(e)?0:WAVE_COLORS.蓝.includes(e)?1:WAVE_COLORS.绿.includes(e)?2:0;case"五行类":return FIVE_ELEMENTS.金.includes(e)?0:FIVE_ELEMENTS.木.includes(e)?1:FIVE_ELEMENTS.水.includes(e)?2:FIVE_ELEMENTS.火.includes(e)?3:FIVE_ELEMENTS.土.includes(e)?4:0;case"肖位类":{const o=getZodiacMap(s);for(let t=1;t<=12;t++){const n=ZODIAC_NAMES[t];if(o[n]?.includes(e))return t}return 1}case"大小单双类":return BIG_SMALL_ODD_EVEN.小单.includes(e)?0:BIG_SMALL_ODD_EVEN.小双.includes(e)?1:BIG_SMALL_ODD_EVEN.大单.includes(e)?2:BIG_SMALL_ODD_EVEN.大双.includes(e)?3:0;default:return e}}function calculateElementValue(e,r){if(e==="期数")return r.period%100;if(e==="期数尾")return r.period%10;if(e==="期数合")return String(r.period).split("").reduce((t,n)=>t+parseInt(n),0);const s=r.numbers[6];return e==="特号"?s:e==="特尾"?s%10:e==="特头"?Math.floor(s/10):e==="特合"?String(s).split("").reduce((t,n)=>t+parseInt(n),0):0}function evaluateExpression(expression,data){let normalized=expression;const elements=["期数","期数尾","期数合","特号","特尾","特头","特合"];for(const e of elements){const r=calculateElementValue(e,data);normalized=normalized.replace(new RegExp(e,"g"),r.toString())}normalized=normalized.replace(/[×\*÷\/%\-]/g,"");try{return/^[\d+()\s]+$/.test(normalized)?Math.floor(eval(normalized)):0}catch(e){return 0}}function applyCycle(e,r){switch(r){case"尾数类":return(e%10+10)%10;case"头数类":return Math.min(Math.max(e,0),4);case"合数类":return Math.min(Math.max(e,0),13);case"波色类":return(e%3+3)%3;case"五行类":return(e%5+5)%5;case"肖位类":return(e%12+12)%12||12;case"大小单双类":return(e%4+4)%4;default:return e}}function getExpandedResults(e,r,s,o){const t=[];if(o==="单特类")for(let n=-r;n<=s;n++){const d=e+n;d>=1&&d<=49&&t.push(d)}else for(let n=-r;n<=s;n++)t.push(applyCycle(e+n,o));return[...new Set(t)]}self.onmessage=e=>{const{type:r,formulas:s,historyData:o,targetPeriod:t}=e.data;if(r==="verify")try{const n=[];for(let l=0;l<s.length;l++){const i=s[l];l%50===0&&self.postMessage({type:"progress",current:l,total:s.length});let a;if(t){const c=o.findIndex(u=>u.period===t);c!==-1?a=o.slice(c,c+i.periods):a=o.slice(0,i.periods)}else a=o.slice(0,i.periods);const p=[],f=[];for(let c=0;c<a.length;c++){const u=a[c],M=c>0?a[c-1]:u,I=evaluateExpression(i.expression,M)+i.offset,_=applyCycle(I,i.resultType),g=getExpandedResults(_,i.leftExpand,i.rightExpand,i.resultType),h=getNumberAttribute(u.numbers[6],i.resultType,u.zodiacYear),S=g.includes(h);p.push(S),f.push({period:u.period,result:_,expandedResults:g,targetValue:h,hit:S})}const E=p.filter(c=>c).length;n.push({formula:{id:`f_${Date.now()}_${l}`,expression:i.rawExpression,rule:i.rule,resultType:i.resultType,offset:i.offset,periods:i.periods,leftExpand:i.leftExpand,rightExpand:i.rightExpand},hits:p,hitCount:E,totalPeriods:a.length,hitRate:a.length>0?E/a.length:0,results:f.length>0?f[0].expandedResults.map(c=>String(c)):[],periodResults:f,originalLineIndex:i.originalLineIndex||0,targetPeriod:t})}self.postMessage({type:"complete",results:n})}catch(n){self.postMessage({type:"error",error:String(n)})}}})();
